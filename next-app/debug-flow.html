<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Flow</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .step { margin: 20px 0; padding: 10px; border: 1px solid #ccc; }
        .success { background-color: #d4edda; }
        .error { background-color: #f8d7da; }
        .info { background-color: #d1ecf1; }
        pre { background: #f8f9fa; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Debug Health Assessment Flow</h1>
    
    <div id="steps"></div>
    
    <button onclick="runDebugFlow()">Run Debug Flow</button>
    <button onclick="clearData()">Clear All Data</button>
    
    <script>
        function addStep(message, type = 'info') {
            const stepsDiv = document.getElementById('steps');
            const stepDiv = document.createElement('div');
            stepDiv.className = `step ${type}`;
            stepDiv.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            stepsDiv.appendChild(stepDiv);
            console.log(message);
        }
        
        function clearData() {
            localStorage.clear();
            addStep('All localStorage data cleared', 'info');
        }
        
        async function runDebugFlow() {
            document.getElementById('steps').innerHTML = '';
            
            try {
                // Step 1: Check localStorage
                addStep('Step 1: Checking localStorage...', 'info');
                const keys = Object.keys(localStorage);
                addStep(`Found ${keys.length} localStorage keys: ${keys.join(', ')}`, 'info');
                
                // Step 2: Check questionnaire data
                const questionnaireData = localStorage.getItem('questionnaireData');
                if (questionnaireData) {
                    addStep('Step 2: Found questionnaire data', 'success');
                    const parsed = JSON.parse(questionnaireData);
                    addStep(`Questionnaire data keys: ${Object.keys(parsed).join(', ')}`, 'info');
                } else {
                    addStep('Step 2: No questionnaire data found', 'error');
                    // Create test data
                    const testData = {
                        age: '30',
                        gender: 'Male',
                        family_history: ['Heart disease'],
                        medical_diagnoses: [],
                        medications: false,
                        diet_type: 'Balanced',
                        exercise_frequency: '3-4 times per week',
                        sleep_hours: '7-8',
                        sleep_quality: 'Good',
                        stress_level: 'Moderate',
                        smoking: false,
                        alcohol: 'Occasionally'
                    };
                    localStorage.setItem('questionnaireData', JSON.stringify(testData));
                    addStep('Created test questionnaire data', 'info');
                }
                
                // Step 3: Check user email
                const userEmail = localStorage.getItem('userEmail');
                if (userEmail) {
                    addStep(`Step 3: Found user email: ${userEmail}`, 'success');
                } else {
                    addStep('Step 3: No user email found', 'error');
                    localStorage.setItem('userEmail', 'test@example.com');
                    addStep('Set test user email', 'info');
                }
                
                // Step 4: Test API call
                addStep('Step 4: Testing API call...', 'info');
                const questionnaireData2 = JSON.parse(localStorage.getItem('questionnaireData'));
                const userEmail2 = localStorage.getItem('userEmail');
                
                // Transform data like loading page does
                const fieldMappings = {
                    'age': 'What is your age?',
                    'gender': 'What is your gender?',
                    'family_history': 'Do you have a family history of any of the following conditions?',
                    'medical_diagnoses': 'Have you been diagnosed with any of the following conditions?',
                    'medications': 'Do you currently take prescription medications or long-term supplements?',
                    'diet_type': 'What type of diet do you follow?',
                    'exercise_frequency': 'How often do you exercise?',
                    'sleep_hours': 'How many hours of sleep do you get per night?',
                    'sleep_quality': 'How would you rate your sleep quality?',
                    'stress_level': 'How would you rate your stress level?',
                    'smoking': 'Do you smoke or use tobacco products?',
                    'alcohol': 'How often do you drink alcohol?'
                };
                
                const answers = [];
                Object.keys(fieldMappings).forEach(field => {
                    if (questionnaireData2[field] !== undefined && questionnaireData2[field] !== null && questionnaireData2[field] !== '') {
                        let answer = questionnaireData2[field];
                        if (Array.isArray(answer)) {
                            answer = answer.join(', ');
                        }
                        if (typeof answer === 'boolean') {
                            answer = answer ? 'Yes' : 'No';
                        }
                        answers.push({
                            question: fieldMappings[field],
                            answer: answer
                        });
                    }
                });
                
                addStep(`Transformed ${answers.length} answers for API`, 'info');
                addStep(`Sample answers: ${JSON.stringify(answers.slice(0, 3), null, 2)}`, 'info');
                
                // Make API call
                const response = await fetch('/api/analyze_health', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        responses: answers,
                        userEmail: userEmail2 
                    })
                });
                
                addStep(`API response status: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (!response.ok) {
                    const errorText = await response.text();
                    addStep(`API error: ${errorText}`, 'error');
                    return;
                }
                
                const results = await response.json();
                addStep('API call successful!', 'success');
                addStep(`Results keys: ${Object.keys(results).join(', ')}`, 'info');
                
                if (results.results) {
                    addStep(`Results.results keys: ${Object.keys(results.results).join(', ')}`, 'info');
                    addStep(`Number of categories: ${results.results.categories ? results.results.categories.length : 'No categories'}`, 'info');
                    
                    // Store results
                    localStorage.setItem('healthAssessmentResults', JSON.stringify(results.results));
                    localStorage.setItem('cachedResults', JSON.stringify(results.results));
                    addStep('Results stored in localStorage', 'success');
                } else {
                    addStep('No results.results found in API response', 'error');
                    addStep(`Full API response: ${JSON.stringify(results, null, 2)}`, 'info');
                }
                
                // Step 5: Test results page
                addStep('Step 5: Testing results page data...', 'info');
                const storedResults = localStorage.getItem('healthAssessmentResults');
                if (storedResults) {
                    const parsedResults = JSON.parse(storedResults);
                    addStep(`Stored results keys: ${Object.keys(parsedResults).join(', ')}`, 'success');
                    addStep(`Has categories: ${parsedResults.categories ? 'Yes' : 'No'}`, 'info');
                    addStep(`Has assessment_summary: ${parsedResults.assessment_summary ? 'Yes' : 'No'}`, 'info');
                } else {
                    addStep('No stored results found', 'error');
                }
                
                addStep('Debug flow completed!', 'success');
                
            } catch (error) {
                addStep(`Error in debug flow: ${error.message}`, 'error');
                console.error('Debug flow error:', error);
            }
        }
    </script>
</body>
</html>
