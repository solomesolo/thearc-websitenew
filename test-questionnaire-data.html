<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Questionnaire Data</title>
</head>
<body>
    <h1>Test Questionnaire Data Collection</h1>
    
    <form id="testForm">
        <h2>Biological Signals</h2>
        <p>Age: <input type="number" name="age" value="35"></p>
        <p>Gender: 
            <input type="radio" name="gender" value="male" checked> Male
            <input type="radio" name="gender" value="female"> Female
        </p>
        
        <h2>Family History</h2>
        <p>Family Health Patterns:
            <input type="checkbox" name="family_health_patterns" value="heart_disease" checked> Heart Disease
            <input type="checkbox" name="family_health_patterns" value="diabetes"> Diabetes
        </p>
        
        <h2>Physiological Patterns</h2>
        <p>Lightheaded when standing:
            <input type="radio" name="lightheaded_standing" value="yes" checked> Yes
            <input type="radio" name="lightheaded_standing" value="no"> No
        </p>
        <p>Skin color changes:
            <input type="radio" name="skin_color_changes" value="yes"> Yes
            <input type="radio" name="skin_color_changes" value="no" checked> No
        </p>
        
        <h2>Lifestyle Load</h2>
        <p>Overwhelmed:
            <input type="radio" name="overwhelmed" value="often"> Often
            <input type="radio" name="overwhelmed" value="sometimes" checked> Sometimes
            <input type="radio" name="overwhelmed" value="never"> Never
        </p>
        
        <h2>Cognitive Rhythm</h2>
        <p>Upset or annoyed:
            <input type="radio" name="upset_annoyed" value="often"> Often
            <input type="radio" name="upset_annoyed" value="sometimes" checked> Sometimes
            <input type="radio" name="upset_annoyed" value="never"> Never
        </p>
        
        <button type="button" onclick="testDataCollection()">Test Data Collection</button>
    </form>
    
    <div id="results"></div>
    
    <script>
        let formData = {};
        
        function handleInputChange(input) {
            const name = input.name;
            const value = input.type === "checkbox" ? 
                (input.checked ? (formData[name] ? formData[name] + "," + input.value : input.value) : 
                (formData[name] ? formData[name].replace(input.value + ",", "").replace("," + input.value, "").replace(input.value, "") : "")) :
                input.value;
            
            if (value) {
                formData[name] = value;
            } else {
                delete formData[name];
            }
            
            console.log("Form data updated:", formData);
        }
        
        function transformQuestionnaireData(formData) {
            console.log("=== TRANSFORMATION DEBUG ===");
            console.log("Input formData:", formData);
            
            const transformedData = {
                user: {
                    name: formData.name || "User",
                    age: parseInt(formData.age) || 30,
                    sex: formData.gender || "other",
                    email: formData.email || ""
                },
                family_history: {
                    cvd: {
                        present: formData.family_health_patterns && formData.family_health_patterns.includes('heart_disease'),
                        first_degree: formData.family_health_patterns && formData.family_health_patterns.includes('heart_disease'),
                        onset: '<60'
                    },
                    diabetes: {
                        present: formData.family_health_patterns && formData.family_health_patterns.includes('diabetes'),
                        first_degree: formData.family_health_patterns && formData.family_health_patterns.includes('diabetes')
                    },
                    cancer: formData.family_health_patterns && formData.family_health_patterns.includes('cancer') ? 
                        [{ type: 'colorectal', relative: 'mother' }] : []
                },
                physiological_patterns: {
                    lightheaded_standing: formData.lightheaded_standing === 'yes' ? 'sometimes' : 'never',
                    skin_color_changes: formData.skin_color_changes === 'yes',
                    temperature_sensitivity: formData.temperature_sensitivity === 'yes' ? 'high' : 'normal'
                },
                lifestyle_load: {
                    overwhelmed: formData.overwhelmed || 'never',
                    confidence_handling: formData.confidence_handling || 'never',
                    in_control: formData.in_control || 'never'
                },
                biological_signals: {
                    age: parseInt(formData.age) || 30,
                    gender: formData.gender || 'other',
                    location: formData.location || 'urban',
                    education: formData.education || 'university',
                    work_status: formData.work_status || 'employed'
                },
                cognitive_rhythm: {
                    upset_annoyed: formData.upset_annoyed || 'never',
                    tense_nervous: formData.tense_nervous || 'never',
                    too_many_demands: formData.too_many_demands || 'never'
                },
                symptoms: {
                    fatigue: formData.fatigue || false,
                    sleep_issues: formData.sleep_issues || false,
                    digestive_issues: formData.digestive_issues || false
                },
                preferences: {
                    budget: formData.budget || 'moderate',
                    equipment: formData.equipment || 'basic',
                    diet: formData.diet || 'flexible'
                }
            };
            
            console.log("Transformed data:", transformedData);
            return transformedData;
        }
        
        function testDataCollection() {
            // Collect all form data
            const form = document.getElementById('testForm');
            const inputs = form.querySelectorAll('input, select, textarea');
            
            inputs.forEach(input => {
                if (input.type === 'radio' && input.checked) {
                    formData[input.name] = input.value;
                } else if (input.type === 'checkbox' && input.checked) {
                    if (formData[input.name]) {
                        formData[input.name] += ',' + input.value;
                    } else {
                        formData[input.name] = input.value;
                    }
                } else if (input.type !== 'radio' && input.type !== 'checkbox') {
                    formData[input.name] = input.value;
                }
            });
            
            console.log("Collected form data:", formData);
            
            // Transform the data
            const transformedData = transformQuestionnaireData(formData);
            
            // Test API call
            testAPI(transformedData);
        }
        
        async function testAPI(data) {
            try {
                console.log("Testing API with data:", data);
                
                const response = await fetch('http://localhost:3002/api/process-personalization', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    throw new Error(`API call failed: ${response.status} ${response.statusText}`);
                }
                
                const results = await response.json();
                console.log("API response:", results);
                
                document.getElementById('results').innerHTML = `
                    <h2>API Results:</h2>
                    <p><strong>Scores:</strong></p>
                    <ul>
                        <li>Family Risk: ${results.scores.family_risk}</li>
                        <li>Physiological: ${results.scores.physiological}</li>
                        <li>Lifestyle Load: ${results.scores.lifestyle_load}</li>
                        <li>Biological: ${results.scores.biological}</li>
                        <li>Cognitive: ${results.scores.cognitive}</li>
                    </ul>
                `;
                
            } catch (error) {
                console.error("API test failed:", error);
                document.getElementById('results').innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }
        
        // Set up event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.addEventListener('change', function() {
                    handleInputChange(this);
                });
            });
        });
    </script>
</body>
</html>




